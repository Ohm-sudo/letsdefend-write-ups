## What is Dynamic Malware Analysis?
- Dynamic malware analysis is when malware is run and examined in secure environments (sandboxes).
- Widely preferred; can perform faster analysis than static.
### Advantages
- Produce faster results.
- Automated analysis with sandboxes.
- Requires less technical knowledge; good for beginners.
### Disadvantages
- Cannot determine full malware capacity.
- Cannot analyze advanced malware relying solely on this method.

## Importance of Dynamic Malware Analysis for SOC Analysts
- When analyzing malware, combine both static and dynamic to analyze it.
- Faster you can detect, faster you can take action.

## Which tools and software do we need?
### Virtualization Software
- Isolates virtual OS from host.
- Perform analysis safely.
- Keep virtualization software updated.
- Examples: VMware, Oracle Virtualbox
### Utility Softwares
- Install software useful for dynamic analysis.
- Examples: MS Office, Adobe Reader, Browser, WinRAR, Text Editors
- Attackers may write malware that detects if frequently used software is installed.
### Debuggers
- Used to change prevention mechanisms of malicious code.
- i.e., If hostname is different than the one we are testing for analyzing malware, then the code can be adjusted to run the malware regardless of hostname.
- Examples: Ollydbg, X64dbg, Windbg, Radare2
### Network Monitoring Tools
- Need software to detect network activities of malware.
- Examples: Wireshark, Fiddler, Burp Suite.
### Process Monitoring Tools
- Need to monitor processes for malware analysis.
- Examples: Process Hacker, Process Explorer (SysInternals), Procmon (SysInternals).
### File Activity Monitoring Tools
- Malware can read, write, and move files to ensure persistence in system.
- Example: Sysmon.
### Other Tools
- SysInternal Tools
- CFF Explorer
- PEView
- TriDNet
- BinText
- PEiD
- Regshot
- HashMyFiles

#### Q1: Which of the following tools is different from the others in terms of its function?
- Ollydbg
- Procmon
- Radare
- IDA
```
Procmon
```
Procmon is a tool for process monitoring. The other tools in this list are for debugging.

#### Q2: What activities cannot be viewed with Procmon?
- Network
- File
- Registry
- Process
- Syscalls
```
Syscalls
```
Procmon cannot see system calls (i.e., NtCreateFile). Debuggers are well suited for this.

#### Q3: Which of the following tools does not provide hash information of files?
- Powershell
- Certutil
- Procmon
- HashMyFile
```
Procmon
```
All other tools except Procmon provides hash info of files.

## Creating Virtual Machine
## Tweaking Virtual Machine
1. Turn off anti-malware solutions.
	i.e., For Microsoft Defender, you can enable the Group Policy: Turn off Microsoft Defender Antivirus.
	
	Navigate to `Computer Configuration > Administrative Templates > Windows Components > Microsoft Defender Antivirus`
	
	You should also disable `Monitor file and program activity on your computer` under `Real-time Protection`

2. Rename your virtual operating system.
	Malware may check hostnames and usernames.

3. Turn off auto updates.
	 i.e., In Windows you can configure automatic updates using group policies.
	 
	 Navigate to `Computer Configuration > Administrative Templates > Windows Components > Windows Updates` and set to disabled.

4. Disable Hidden Extensions
	 Attackers trick victims by changing file extensions.
	 In Windows File Explorer you can click on `File` -> `Change folder and search options` -> Save settings by unchecking `Hide extensions for known file types`

5. Show Hidden Files and Folders
	 Navigate to where we just disabled hidden extensions and check `Show hidden files, folders, and drives`.

6. Disable ASLR.
	 ASLR (Address Space Layout Randomization) is an anti-exploit security mechanism. This should be disabled.
	 
	 Can be disabled by navigating to the following in Registry Editor:
	 `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management`
	 
	 Create a `REG_DWORD` type key named `MoveImages`.

7. Disable Windows Firewall.

8. Mimic an End-User System
	 - Install browsers like Chrome and Firefox.
	 - Leave files in different directories of interest to attackers.
	 - Change desktop background.
	 - Download small applications through browser.

9. Change Network Settings

### Take a Snapshot
- "Backups" of a virtual machine.
- Return to a certain point in time or state of virtual machine.
- Ideal when wanting to return to changes prior to running the malware.

#### Q1: What is the Network configuration that provides Internet access through the network interface of the host operating system?
- NAT
- Bridge
- Host-Only
- Private
```
NAT
```
Bridge provides a network connection as if there was another host on the host machine's network.

Host-Only only communicates with the host machine (not the Internet).

Private means only VMs talk with each other.

So NAT provides the option of communicating with the Internet through the network interface of the host (the VM remains hidden).

#### Q2: What name should a registry key be created to disable the ASLR feature?
```
MoveImages
```

## What Should We Pay Attention to when we conduct a Dynamic Analysis?
### Process Activities
- When malware is run, it creates processes.
- Must detect processes belonging to malware first.
- Take note on whether it can create new child processes, import DLLs, and which user it is run by.
- Process Hacker can be used to examine processes.
### Network Activities
- Malware establish network connection for second payload.
- Communicate with C2 servers, lateral movement, or steal data.
- WireShark or Fiddler (malware communication over HTTP) can be used.
### Registry Activities
- Registries are hierarchical databases used for data storage in Windows OSs.
	- Used by attackers to steal data and ensure persistence.
- Examples:
	- HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
	- HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
	- HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
	- HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
- You can use an application called RegShot to detect changes malware made on Registries.
	- 1st shot - Collect registries.
	- 2nd shot - Show registry activity.

### File Activities
- Malware often copies themselves to temp directory (applications typically use this to host volatile files).
- Win + R -> Enter %temp% to access the directory.
- Malware also copies itself to startup directory to ensure persistence.
- Can access the directory by entering the following commands:
	- shell:startup
	- shell:common startup

#### Q1: Which tool should be used to detect network activities?  
- Regshot  
- HashMyFiles  
- Fiddler  
- Process Hacker 
```
Fiddler
```

#### Q2: What command should be typed in the "Run" application to switch to the “temp folder”.
```
%temp%
```

## Dynamic Malware Analysis Example #1
- Procmon shows terminated processes. Useful in combination with Process Hacker.
	- Malware creates processes which then creates child processes which are deleted (not found in Process Hacker).

### 1. Preparation
- Run Process Hacker. Pay attention to where malware is being run.
- Run Procmon to view process, file, registry, and network activities.
- Run RegShot to see registry activities. Take 1st shot before running malware.
- Use Wireshark or Fiddler to view network activities.
### 2. Analyze
- Allow enough time for malware to perform activity. Then on Regshot click the 2nd shot button.
- Check Process Hacker and Procmon (Show Process Tree).
	- Examine process details.
	- Filter for malware processes (Add process and children to Include filter).
- Check Network, Registry, File activities on Procmon.

For the questions below, you can find the answers using VirusTotal, but for the sake of the lesson, learn the process of dynamic malware analysis.

#### Q1: What is the domain name that the malware connects to for data hijacking?
```
us2.smtp.mailhostbox.com
```

#### Q2: (Desktop/Malware Samples/law.exe) Connect Virtual Machine via 'Connect' Button. On which port does the malware communicate over?
```
587
```

#### Q3: (Desktop/Malware Samples/law.exe) Connect Virtual Machine via 'Connect' Button. What is the name of the executable file that the malicious application writes to the AppData directory?
```
AheGmkp.exe
```

#### Q4: (Desktop/Malware Samples/law.exe) Connect Virtual Machine via 'Connect' Button. Which Registry Key does the malware use to ensure persistence?
```
HKEY_CURRENT_USER\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

## Dynamic Malware Analysis Example #2
- Can use HashMyFile to get the hash of file on machine.

***Don't forget you can use AnyRun to perform Dynamic Malware Analysis***

#### Q1: (Desktop/Malware Samples/payment advice.exe)(Password:infected) Connect Virtual Machine via 'Connect' Button. What is the domain name of the web application that the malware is requesting to learn its IP address?
```
checkip.dyndns.org
```

#### Q2: (Desktop/Malware Samples/payment advice.exe) What is the domain name that the malware connects to for data hijacking?
```
mail.stilltech.ro
```

#### Q3: (Desktop/Malware Samples/payment advice.exe) What port does the malware communicate over?
```
587
```

#### Q4: (Desktop/Malware Samples/payment advice.exe) What is the username used by the malware to authenticate to the mail server it connects for data hijacking?
```
office@stilltech.ro
```

#### Q5: (Desktop/Malware Samples/payment advice.exe) What is the password that the malware uses to authenticate to the mail server it connects for data hijacking?
```
eurobit555ro
```


## My Malware Doesn't Do Anything?
- Wait a little longer - attacks may only occur after a period of time.
- Execute as administrator.
- Change language settings.
- Use different network - attackers may check if device is located in desired location for attack.
- Run malware from different directory.
- Change screen resolution.
- Perform activities (i.e., moving mouse) while malware running.

#### Which filter should be created to list process creation events in Procmon?
```
Operation is Process Start
```

#### Which command should be entered in the "Run" application to access the directory where the applications that will start automatically when the operating system is started are stored?
```
shell:startup
```

#### Which of the following is not a method used by malware to ensure persistence?
```
Renaming itself
```
