- Malware analysis determining function, origin, and impact of malware.
- Two types: static and dynamic.
	- Static - without execution.
	- Dynamic - study while malware is executed.
- Snapshots = checkpoints
- Disable Windows updates -> Services, and Windows Defender
	- Need this to perform malware analysis.
- Disable Hide Extensions for known file types.
- Show Hidden Files and Folders.
- **----1st snapshot at this point----**
- **Set Virtual Machine Network Adapter to Host-Only prior to performing malware analysis.**
- Download FlareVM (madiant/flare-vm on GIthub)
	- Installation will take a while (~3 hours).
	- Once the installation is complete, ensure the following tools are there:
		- FakeNet
		- HashMyFiles or HashCalc
		- Regshot
		- Ghidra
- **----2nd snapshot at this point----**
## Static Malware Analysis Fundamentals
- Going to be looking at two files: **malware-sample-2.zip** and **XMoon.bin.zip**
	- Unzip. Password is *infected* for XMoon.
	- Password is *crackingsamples.com* for malware-sample.
1. File Type
	- Use `HxD` to determine file type.
	- Keywords/signature (tell us executable): MZ, 4D 5A, This program cannot be run in DOS mode
	- Important because you might think file is an image but is actually an executable file.
	- `Cmder` also tells us the file type of suspicious file.

2. Fingerprinting the malware (get hash)
	- We want to submit to VirusTotal to determine if malware.
	- `HashCalc` or `HashMyFiles` will give you the hash of the file.

3. Strings
	- Tells us what words are in the file - C2 servers, IP addresses.
	- Base64 or any encoding techniques.
	- `Cmder` run the following commands:
		- `strings -n 5 <file>`
			- Looks for words greater than length of 5
		- `strings -n 5 <file> > output.txt`
			- Puts the output into a notepad.
	- `BinText` also finds strings in the file.

4. Decrypting Encoded Strings
	- `XorSearch`
		- Use `XorSearch` command in `Cmder`
		- Commands:
			- `XorSearch <file> http`
			- `XorSearch <file> This`
			- `XorSearch <file> Create`
	- `Floss`
		- Use `floss` command in `Cmder`
		- Commands:
			- `floss <file>`
		- Finds encrypted strings and lists them at the bottom of output.

5. Packing
	- Modify formatting of code by compressing or encrypting data.
	- Malware actors do this to avoid detection from VirusTotal, antiviruses.
	- `Exeinfo PE` - Tool for determining packer used in file.
	- `UPX` is an example of a packer.
		- `upx -d -o <unpacked_file> <file>`
	- Unpacked is bigger than the packed version.
	- `pestudio`- Gives the hash, packing technique, malicious indicators, VirusTotal results, strings

**Note:** Connect to the lab machine and use the "C:\Users\LetsDefend\Desktop\Malware\XMoon.bin" file for solving the questions below.  
  
#### Q1: What is the actual extension of the "XMoon.bin" file?
```
exe
```
If you open the file in HxD, you can see in the hex data the keywords: 4D 5A and This program cannot be run in DOS mode - indicating that the file is an executable file (.exe).

#### Q2: What are the first 4 characters you will see when you open the XMoon.bin file with the Hex editor? (Do not put spaces between characters.)
```
4D5A
```


**Note:** Connect to the lab machine and use the "C:\Users\LetsDefend\Desktop\Malware\financials-xls.exe" file for solving the questions below.  
  
#### Q3: What is the signature value of "financials-xls" file?
```
UPX -> www.upx.sourceforge.net
```
Open the file in pestudio then look at the value of the signature field.

#### Q4: What is the actual file size of the "financials-xls" file? (byte)
```
43520
```
You can find this using the `ExeInfo PE` tool

## Dynamic Malware Analysis
- Using a different sample called e-Archive_Devkont.bin.zip.

1. 4 things to look out for:
	- Process Hacker
	- Procmon
	- Malware creates processes in the background - need to identify when malware executed.

2. Network Activity
	- Malware wants to contact C2 server.
	- Wireshark (Filter for smtp, http, DNS)

3. Registry Activity
	- Look for persistence (malware stays on infected computer)
	- regshot
	- Procmon
	- Keys to look for (startup)
		- `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
		- `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`
		- `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
		- `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`

4. File Activities
	- Again for persistence.
	- regshot
	- Procmon
	- `C:\Users\Usernme\AppData\Roaming`
	- Win + R
		- `%TEMP%`
		- `shell:startup`
		- `shell:common startup`

- First open **Wireshark**, **Process Hacker**, and **Regshot**.
	- Wireshark: Double click on Ethernet connection.
	- Process Hacker: Leave it open on the side of screen.
	- Regshot: Click on **1st shot**.
		- This will take some time.
- Open **Procmon**, then unzip the malware. Change the extension of the unzipped malware to executable. Execute it and run as administrator.
	- Process Hacker may not be able to show the child processes (cause they got terminated instantly).
	- **Procmon shows terminated processes created by parent process (malware)**
	- Wait 3-4 minutes.
- On **Wireshark** stop the capture. On **Procmon** click on the highlighted capture button.
	- Procmon: Click on Process Tree - this shows the subprocesses created by the malware.
		- Take note of directories, scheduled tasks (schtasks.exe), PowerShell commands.
	- Wireshark: Filter for smtp, http, DNS
		- Look for suspicious domains
		- maxmind.com/en/geoip-demo
			- Paste IP to website to locate where IP address is coming from.
			- AbuseIPDB is an alternative.
- Now go to **Regshot** and click **2nd shot**
	- Again this will take some time.
	- Need 1st and 2nd shot to compare registry key values.
	- Search for key values added or changed
		- You can search by malware name.
- Open **Procmon**
	- Check `C:\Users\Username\AppData\Roaming\.exe`
	- Show file system activity (only).

**Note:** Connect to the lab machine and use the "C:\Users\LetsDefend\Desktop\Malware\e-Archive Dekont.bin" file for solving the questions below.  

#### Q1: What is the domain address where the "e-Archive Dekont" file sends the DNS request?
```
5gw4d.xyz
```

#### Q2: File "e-Archive Dekont" has created a scheduled task. What is the action value of this task? (Full path)
```
C:\Users\LetsDefend\AppData\Roaming\VbxFiQYCyFDgGL.exe
```
Open Task Scheduler and search for the task associated with the malware. If you look at the Actions tab, the action value can be found.
